/**
 * 
 */
package com.pramati.imaginea.bObj;

import java.io.BufferedInputStream;
import java.io.BufferedWriter;
import java.io.ByteArrayInputStream;
import java.io.File;
import java.io.FileWriter;
import java.io.InputStream;
import java.net.URL;
import java.net.URLConnection;
import java.nio.charset.StandardCharsets;

import javax.mail.internet.MimeMessage;
import javax.xml.bind.JAXBContext;
import javax.xml.bind.Unmarshaller;

import com.pramati.imaginea.Entities.mail;
import com.pramati.imaginea.Exceptions.NoDataException;
import com.pramati.imaginea.base.WebElement;

/**
 * This Abstract class is an implementation of web element and used to represent
 * a Link in the web page. All the methods defined in this class are specific to
 * how web link should behave.
 * 
 * @author anandu
 *
 */
public class WebMailLink extends WebLink {
	
	private static int FILE_COUNT = 0;
	private boolean loaded;
	private StringBuilder DAT_HOLDER = new StringBuilder();
	//mail email;
	/**
	 * 
	 */
	public WebMailLink(URL url) {
		super(url);
		this.loaded = false;
	}
	/**
	 * @return the linkUrl
	 */
	public URL getLinkUrl() {
		return LINK_URL;
	}
	/* (non-Javadoc)
	 * @see com.pramati.imaginea.base.WebElement#save(java.lang.Object)
	 */
	@Override
	public void save(File targetFile) throws Exception {
		
		if(!loaded) {
			load();
		}
		InputStream stream = new ByteArrayInputStream(DAT_HOLDER.toString().getBytes(StandardCharsets.UTF_8));
		MimeMessage message = new MimeMessage(null, stream);
		File lFile = new File(targetFile, message.getSubject()+"_"+message.getSentDate());
		while(!lFile.createNewFile()){
			lFile = new File(targetFile, message.getSubject()+"_"+message.getSentDate()+FILE_COUNT++);
		}
		FileWriter lWriter = new FileWriter(lFile.getAbsoluteFile());
		BufferedWriter lBuffer = new BufferedWriter(lWriter);
		lBuffer.write(DAT_HOLDER.toString());
		lBuffer.flush();
		lBuffer.close();
	}

	@Override
	public void load() throws Exception {
		
		/*JAXBContext jaxbContext = JAXBContext.newInstance(mail.class);  
		Unmarshaller jaxbUnmarshaller = jaxbContext.createUnmarshaller();  
		email = (mail) jaxbUnmarshaller.unmarshal(linkUrl);*/
		URLConnection urlc = linkUrl.openConnection();
		BufferedInputStream buffer = new BufferedInputStream(urlc.getInputStream());
		int byteRead;
		while ((byteRead = buffer.read()) != -1)
			DAT_HOLDER.append((char) byteRead);
		
		loaded = true;
	}

}
